# Stripe Billing Setup

Warrify relies on Stripe Checkout + the Billing Portal for all paid-plan management. This guide covers the required environment variables, how to configure plans, and how to test webhooks locally.

## Environment variables

### Backend (`backend/.env`)
| Key | Description |
| --- | --- |
| `STRIPE_SECRET_KEY` | Secret API key created in your Stripe dashboard (use the *test* key locally). |
| `STRIPE_WEBHOOK_SECRET` | Secret generated by `stripe listen` (or your dashboard) for verifying webhook signatures. |
| `FRONTEND_URL` | Base URL for the SPA (used to build success/cancel URLs). |
| `STRIPE_PRICE_ENTERPRISE_MONTHLY` | Price ID for the Enterprise monthly subscription. |
| `STRIPE_PRICE_ENTERPRISE_YEARLY` | Price ID for the Enterprise yearly subscription. |
| `STRIPE_PRICE_PRO_MONTHLY` | Price ID for the Pro monthly subscription. |
| `STRIPE_PRICE_PRO_YEARLY` | Price ID for the Pro yearly subscription. |
| `STRIPE_PRICE_PREMIUM_MONTHLY` | Price ID for the Premium monthly subscription. |
| `STRIPE_PRICE_PREMIUM_YEARLY` | Price ID for the Premium yearly subscription. |
| `STRIPE_BILLING_PORTAL_RETURN_URL` *(optional)* | Override for the Billing Portal return URL (defaults to `${FRONTEND_URL}/profile`). |

All of the price IDs must exist before the server starts; configuration is validated during boot and the API will fail fast if any variable is missing.

### Frontend (`Front-end/.env`)
| Key | Description |
| --- | --- |
| `VITE_BASE_URL` | Base URL for API requests (usually `http://localhost:8080`). |
| `VITE_STRIPE_PUBLISHABLE_KEY` | Publishable key used by `@stripe/stripe-js` to redirect to Checkout. |

## Creating test products/prices
1. In the Stripe Dashboard (Test mode), create a **Product** for each paid plan (`Enterprise`, `Pro`, `Premium`) or reuse a single product with multiple prices.
2. Under each product, create two recurring prices:
   - Billing period: `Monthly` and `Yearly`
   - Currency: `RON` (or whatever you charge in production)
   - Keep quantity `1`
3. Copy the generated `price_...` IDs into the corresponding environment variables listed above.
4. (Optional) Enable promotion codes on each price if you want them redeemed during Checkout—Warrify already enables promotion codes on the session object.

## Local webhook & billing portal testing
1. Run both apps in separate terminals:
   ```bash
   cd backend && npm run start
   cd Front-end && npm run dev
   ```
2. Start the Stripe CLI listener so events are forwarded to your dev server:
   ```bash
   stripe listen --events checkout.session.completed,customer.subscription.updated,customer.subscription.deleted,invoice.payment_failed --forward-to localhost:8080/stripe/webhook
   ```
   The CLI prints a `whsec_...` secret—copy that into `STRIPE_WEBHOOK_SECRET`.
3. Use `stripe trigger checkout.session.completed` (and the other events) to validate that MongoDB receives fresh billing data.
4. When logged in, go to `/pricing`, pick a paid plan, and Stripe Checkout will open in subscription mode. Use the standard test card `4242 4242 4242 4242` to complete payment.
5. After payment, Stripe redirects to `/profile?checkout=success`; canceling returns to `/pricing?checkout=cancel`.
6. Open `/profile` to confirm the subscription card shows:
   - Plan name + billing interval
   - Active status pill (`trialing`/`past_due` show warning colors)
   - Renewal or cancellation date pulled from `billing.currentPeriodEnd`
   - A **Manage billing** button that opens the Stripe Billing Portal (if the user has an active subscription)

When you are done testing, stop `stripe listen` to avoid sending events to a dead endpoint.
